/* ZX Server

Controls communication to the ZX computer by listening to signal_from and 
sending data via signal_to modules.

Works asynchroously, thus communication is done via queues

*/

#include <stdio.h>
#include <string.h>
#include <sys/unistd.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "esp_err.h"
#include "esp_log.h"


#include "zx_server.h"
#include "signal_to_zx.h"

static const char *TAG = "zx_server";


static QueueHandle_t msg_queue=NULL;



// demo p file
const uint8_t pfile[]={  0xA6,  0x0,0xa,0x0,0x88,0x40,0x89,0x40,0xa1,0x40,0x0,0x0,0xa2,0x40,0xaa,0x40,0x0,0x0,0xab,0x40,0xab,0x40,0x0,0x5d,0x40,0x0,0x2,0x0,0x0,0xbf,0xfd,0xff,0x37,0x88,0x40,0x0,0x0,0x0,0x0,0x0,0x8d,0xc,0x0,0x0,0xa2,0xf8,0x0,0x0,0xbc,0x21,0x18,0x40,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x76,0x0,0x0,0x0,0x0,0x0,0x0,0x84,0x0,0x0,0x0,0x84,0xa0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xa,0x7,0x0,0xea,0x2d,0x2a,0x31,0x31,0x34,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x80};


static void zxsrv_task(void*arg)
{
    zxserv_event_t evt;
    ESP_LOGI(TAG,"sfzx_task START \n");
    while(true){
		if(pdTRUE ==  xQueueReceive( msg_queue, &evt, 10 / portTICK_RATE_MS ) ) {
			ESP_LOGI(TAG,"Retrieved evt %d",evt.evt_type);
            if(evt.evt_type==ZXSG_HIGH){
                // Load
                ESP_LOGI(TAG,"Send file to load \n");
                stzx_send_cmd(STZX_FILE_START,0);
                for(size_t i=0;i<sizeof(pfile);i++){
                    stzx_send_cmd(STZX_FILE_DATA,pfile[i]);                    
                }
                stzx_send_cmd(STZX_FILE_END,0);
			}
			else ESP_LOGW(TAG,"Unexpected evt %d",evt.evt_type);
		}
    }
}



void zxsrv_init()
{
    msg_queue=xQueueCreate(10,sizeof( zxserv_event_t ) );
    xTaskCreate(zxsrv_task, "zxsrv_task", 1024 * 2, NULL, 8, NULL);
}


void zxsrv_send_msg_to_srv( zxserv_evt_type_t msg, size_t dat)
{
    zxserv_event_t evt;
	evt.evt_type=msg;
	evt.data=dat;
	if( xQueueSendToBack( msg_queue,  &evt, 100 / portTICK_RATE_MS ) != pdPASS )
	{
		// Failed to post the message, even after 100 ms.
		ESP_LOGE(TAG, "Server write queue blocked");
	}
}
